name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 3 * * *" # Daily at 3 AM

env:
  LLC_POSTGRES_DSN: postgresql://local:localpw@localhost:5433/registry
  LLC_QDRANT_URL: http://localhost:6333
  LLC_MINIO_ENDPOINT: http://localhost:9000
  LLC_MINIO_ACCESS_KEY: localminio
  LLC_MINIO_SECRET_KEY: localminio123
  LLC_MCP_TOKEN: local-dev-token
  MCP_URL: http://localhost:7801
  PYTHONUNBUFFERED: "1"
  CI_E2E: ${{ vars.CI_E2E || '1' }}

jobs:
  backend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Enforce pinned images
        run: |
          ./scripts/check_no_latest_images.sh

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ./mcp-server[dev]
          pip install -e ./workers[dev]

      - name: Install frontend dependencies for E2E (Playwright)
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ runner.temp }}/pw-browsers
        run: |
          cd frontend
          npm install
          npx playwright install --with-deps

      - name: Frontend unit tests (Vitest)
        env:
          NEXT_TELEMETRY_DISABLED: 1
        run: |
          cd frontend
          npm run test:ci

      - name: Bring up Compose stack (Postgres, Qdrant, MinIO, MCP, workers)
        run: |
          docker compose -f docker/compose.local.yaml up -d --build

      - name: Wait for services
        run: |
          for i in {1..30}; do
            if pg_isready -h localhost -p 5433 -U local; then break; fi
            echo "Waiting for Postgres..."
            sleep 2
          done
          ./scripts/bootstrap_db.sh
          for i in {1..30}; do
            if curl -sf "$MCP_URL/health" > /dev/null; then break; fi
            echo "Waiting for MCP..."
            sleep 2
          done

      - name: Alembic autogenerate check
        run: |
          python scripts/check_alembic_autogenerate.py

      - name: Pytest (unit + integration + coverage)
        env:
          CI_INTEGRATION: "1"
        run: |
          mkdir -p .artifacts
          pytest mcp-server/tests -q --maxfail=1 --disable-warnings \
            --cov=app --cov-report=term-missing \
            --cov-report=xml:.artifacts/coverage.xml \
            --junitxml=.artifacts/pytest-junit.xml

      - name: Smoke tests (compose stack)
        run: |
          make smoke

      - name: Golden queries (budget 900ms)
        run: |
          scripts/run_golden_queries.sh --budget-ms 900

      - name: E2E search (Playwright, required)
        env:
          NEXT_PUBLIC_MCP_BASE_URL: http://localhost:7801
          PLAYWRIGHT_BROWSERS_PATH: ${{ runner.temp }}/pw-browsers
        run: |
          if [ "${CI_E2E}" = "0" ]; then
            echo "Skipping E2E (CI_E2E=0)";
            exit 0;
          fi
          export NEXT_PUBLIC_MCP_TOKEN="${LLC_MCP_TOKEN}"
          cd frontend
          NEXT_TELEMETRY_DISABLED=1 npm run dev -- --hostname 0.0.0.0 --port 3000 >/tmp/next.log 2>&1 &
          FRONTEND_PID=$!
          sleep 10
          npm run e2e:search
          kill $FRONTEND_PID

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: |
            .artifacts/
            frontend/playwright-report/
            /tmp/next.log
          retention-days: 30

      - name: Teardown
        if: always()
        run: |
          docker compose -f docker/compose.local.yaml down -v
